// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// URL CORRETA DO SUPABASE (for√ßar se necess√°rio)
const CORRECT_SUPABASE_URL = 'https://zunuqaidxffuhwmvcwul.supabase.co';
const CORRECT_SUPABASE_KEY = 'sb_publishable_BT7lsfrAYrPII7bsH_I6WA_zmDkhorc';

// Usar vari√°veis de ambiente ou valores corretos como fallback
let SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL || CORRECT_SUPABASE_URL;
let SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY || CORRECT_SUPABASE_KEY;

// FOR√áAR URL CORRETA (corrige problema de cache/URL antiga do Bolt)
if (SUPABASE_URL !== CORRECT_SUPABASE_URL) {
  console.warn('‚ö†Ô∏è [SUPABASE] URL incorreta detectada, corrigindo...');
  console.warn('   URL antiga:', SUPABASE_URL);
  SUPABASE_URL = CORRECT_SUPABASE_URL;
  console.log('‚úÖ [SUPABASE] URL corrigida para:', SUPABASE_URL);
}

// Debug: Verificar configura√ß√£o
if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  console.error('‚ùå [SUPABASE] Vari√°veis de ambiente n√£o configuradas!');
  console.error('   VITE_SUPABASE_URL:', SUPABASE_URL);
  console.error('   VITE_SUPABASE_PUBLISHABLE_KEY:', SUPABASE_PUBLISHABLE_KEY ? 'OK' : 'FALTANDO');
} else {
  console.log('‚úÖ [SUPABASE] Configurado:', SUPABASE_URL);
  console.log('‚úÖ [SUPABASE] URL esperada: https://zunuqaidxffuhwmvcwul.supabase.co');
  
  // Verificar se a URL est√° correta
  if (SUPABASE_URL !== 'https://zunuqaidxffuhwmvcwul.supabase.co') {
    console.warn('‚ö†Ô∏è [SUPABASE] URL diferente da esperada');
    console.warn('   URL atual:', SUPABASE_URL);
    console.warn('   URL esperada: https://zunuqaidxffuhwmvcwul.supabase.co');
  }
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// FOR√áAR URL CORRETA SEMPRE (ignora qualquer cache/env)
const FINAL_SUPABASE_URL = CORRECT_SUPABASE_URL;
const FINAL_SUPABASE_KEY = CORRECT_SUPABASE_KEY;

console.log('üîß [SUPABASE] Inicializando com URL for√ßada:', FINAL_SUPABASE_URL);

// INTERCEPTOR: Corrige URLs antigas em requisi√ß√µes (FETCH + XMLHttpRequest)
if (typeof window !== 'undefined') {
  // INTERCEPTAR FETCH
  const originalFetch = window.fetch;
  window.fetch = async function(input: RequestInfo | URL, init?: RequestInit): Promise<Response> {
    let url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : (input && 'url' in input ? input.url : '');
    
    // Se a URL cont√©m a URL antiga do Bolt ou projeto antigo, substituir pela correta
    if (url && (url.includes('qbtqjrcfseqcfmcqlngr') || url.includes('gbtqjrcfseqcfmcqlngr') || url.includes('jibpvpqgplmahjhswiza'))) {
      const correctedUrl = url.replace(/https?:\/\/[^/]+\.supabase\.co/g, FINAL_SUPABASE_URL);
      console.warn('‚ö†Ô∏è [CLIENT-FETCH] URL antiga detectada, corrigindo:');
      console.warn('   Antiga:', url.substring(0, 100));
      console.warn('   Nova:', correctedUrl.substring(0, 100));
      url = correctedUrl;
      
      // Recriar o input com a URL corrigida
      if (typeof input === 'string') {
        input = url;
      } else if (input instanceof URL) {
        input = new URL(url);
      } else if (input && 'url' in input) {
        input = new Request(url, input);
      }
    }
    
    return originalFetch.call(this, input, init);
  };
  
  // INTERCEPTAR XMLHttpRequest (Supabase pode usar isso tamb√©m)
  const OriginalXHR = window.XMLHttpRequest;
  window.XMLHttpRequest = function() {
    const xhr = new OriginalXHR();
    const originalOpen = xhr.open;
    
    xhr.open = function(method: string, url: string | URL, ...args: any[]) {
      const urlStr = typeof url === 'string' ? url : url.toString();
      if (urlStr && (urlStr.includes('qbtqjrcfseqcfmcqlngr') || urlStr.includes('gbtqjrcfseqcfmcqlngr') || urlStr.includes('jibpvpqgplmahjhswiza'))) {
        const correctedUrl = urlStr.replace(/https?:\/\/[^/]+\.supabase\.co/g, FINAL_SUPABASE_URL);
        console.warn('‚ö†Ô∏è [CLIENT-XHR] URL antiga detectada, corrigindo:', urlStr.substring(0, 100), '‚Üí', correctedUrl.substring(0, 100));
        return originalOpen.call(this, method, correctedUrl, ...args);
      }
      return originalOpen.call(this, method, url, ...args);
    };
    
    return xhr;
  };
  
  console.log('‚úÖ [CLIENT] Interceptores de fetch e XMLHttpRequest instalados');
}

export const supabase = createClient<Database>(FINAL_SUPABASE_URL, FINAL_SUPABASE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  },
  global: {
    headers: {
      'x-client-info': 'amzofertas-web'
    }
  }
});

// FOR√áAR URL CORRETA NO CLIENTE (override se necess√°rio)
if (supabase.supabaseUrl !== FINAL_SUPABASE_URL) {
  console.warn('‚ö†Ô∏è [SUPABASE] Cliente criado com URL incorreta! For√ßando corre√ß√£o...');
  console.warn('   URL atual:', supabase.supabaseUrl);
  // Tentar corrigir via propriedade (se poss√≠vel)
  try {
    (supabase as any).supabaseUrl = FINAL_SUPABASE_URL;
    console.log('‚úÖ [SUPABASE] URL corrigida no cliente');
  } catch (e) {
    console.error('‚ùå [SUPABASE] N√£o foi poss√≠vel corrigir URL diretamente:', e);
  }
}

// Verificar se o cliente est√° usando a URL correta
console.log('‚úÖ [SUPABASE] Cliente criado com URL:', supabase.supabaseUrl);
console.log('‚úÖ [SUPABASE] URL esperada:', FINAL_SUPABASE_URL);
console.log('‚úÖ [SUPABASE] URLs coincidem?', supabase.supabaseUrl === FINAL_SUPABASE_URL ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå');

// FOR√áAR URL CORRETA NO CLIENTE SUPABASE (SOBRESCREVER DIRETAMENTE)
if (typeof window !== 'undefined') {
  // Tentar sobrescrever a propriedade supabaseUrl diretamente
  try {
    Object.defineProperty(supabase, 'supabaseUrl', {
      value: FINAL_SUPABASE_URL,
      writable: true,
      configurable: true
    });
    console.log('‚úÖ [FORCE-URL] URL for√ßada diretamente no cliente:', FINAL_SUPABASE_URL);
  } catch (e) {
    console.warn('‚ö†Ô∏è [FORCE-URL] N√£o foi poss√≠vel sobrescrever supabaseUrl diretamente, usando wrapper');
  }
  
  // Verificar e corrigir novamente ap√≥s um delay (caso seja sobrescrito)
  setTimeout(() => {
    if (supabase.supabaseUrl !== FINAL_SUPABASE_URL) {
      console.warn('‚ö†Ô∏è [FORCE-URL] URL foi alterada novamente! Corrigindo...');
      try {
        (supabase as any).supabaseUrl = FINAL_SUPABASE_URL;
      } catch (e) {
        console.error('‚ùå [FORCE-URL] Erro ao corrigir URL:', e);
      }
    }
  }, 100);
}

// WRAPPER: Garantir que functions.invoke sempre use URL correta
if (typeof window !== 'undefined' && supabase.functions) {
  // Criar cliente de backup com URL correta
  const backupClient = createClient<Database>(FINAL_SUPABASE_URL, FINAL_SUPABASE_KEY, {
    auth: {
      storage: localStorage,
      persistSession: true,
      autoRefreshToken: true,
    },
    global: {
      headers: {
        'x-client-info': 'amzofertas-web'
      }
    }
  });
  
  // Copiar sess√£o do cliente original para o backup
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      backupClient.auth.setSession({
        access_token: session.access_token,
        refresh_token: session.refresh_token
      });
    }
  });
  
  const originalInvoke = supabase.functions.invoke.bind(supabase.functions);
  
  supabase.functions.invoke = async function(functionName: string, options?: any) {
    console.log('üì§ [FUNCTIONS.INVOKE] Chamando fun√ß√£o:', functionName);
    console.log('üì§ [FUNCTIONS.INVOKE] URL base do cliente atual:', supabase.supabaseUrl);
    console.log('üì§ [FUNCTIONS.INVOKE] URL correta esperada:', FINAL_SUPABASE_URL);
    
    // FOR√áAR URL CORRETA ANTES DE CHAMAR
    if (supabase.supabaseUrl !== FINAL_SUPABASE_URL) {
      console.warn('‚ö†Ô∏è [FUNCTIONS.INVOKE] URL incorreta detectada! For√ßando corre√ß√£o...');
      try {
        (supabase as any).supabaseUrl = FINAL_SUPABASE_URL;
      } catch (e) {
        console.error('‚ùå [FUNCTIONS.INVOKE] Erro ao for√ßar URL:', e);
      }
    }
    
    // SEMPRE usar o cliente de backup (que tem URL correta garantida)
    return backupClient.functions.invoke(functionName, options);
  };
  
  console.log('‚úÖ [FUNCTIONS.INVOKE] Wrapper instalado - sempre usa URL correta');
}