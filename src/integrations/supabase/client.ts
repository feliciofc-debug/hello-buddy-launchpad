// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// ‚ö†Ô∏è HARDCODED - N√ÉO USAR import.meta.env (evita URL antiga no bundle)
const supabaseUrl = 'https://zunuqaidxffuhwmvcwul.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bnVxYWlkeGZmdWh3bXZjd3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjQ2NjgsImV4cCI6MjA4NDQwMDY2OH0.PGDZSDZ1fc01cs8HHulK1HSSv2UHl2sHuanCwIow6L4';

console.log('üîß [SUPABASE CLIENT] Inicializando com URL:', supabaseUrl);

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  },
  global: {
    headers: {
      'x-client-info': 'amzofertas-web'
    }
  }
});

// Valida√ß√£o em runtime
if (typeof window !== 'undefined') {
  console.log('‚úÖ [SUPABASE CLIENT] Cliente criado');
  console.log('üìç [SUPABASE CLIENT] URL atual:', supabase.supabaseUrl);
  
  // Se a URL estiver errada, ABORTAR
  if (!supabase.supabaseUrl.includes('zunuqaidxffuhwmvcwul')) {
    const erro = `üö® URL INCORRETA: ${supabase.supabaseUrl}. Esperado: zunuqaidxffuhwmvcwul`;
    console.error(erro);
    alert(erro);
    throw new Error(erro);
  }
}

// INTERCEPTOR: Corrige URLs antigas em requisi√ß√µes (FETCH + XMLHttpRequest)
if (typeof window !== 'undefined') {
  // INTERCEPTAR FETCH
  const originalFetch = window.fetch;
  window.fetch = async function(input: RequestInfo | URL, init?: RequestInit): Promise<Response> {
    let url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : (input && 'url' in input ? input.url : '');
    
    // Se a URL cont√©m a URL antiga do Bolt ou projeto antigo, substituir pela correta
    if (url && (url.includes('qbtqjrcfseqcfmcqlngr') || url.includes('gbtqjrcfseqcfmcqlngr') || url.includes('jibpvpqgplmahjhswiza'))) {
      const correctedUrl = url.replace(/https?:\/\/[^/]+\.supabase\.co/g, supabaseUrl);
      console.warn('‚ö†Ô∏è [CLIENT-FETCH] URL antiga detectada, corrigindo:');
      console.warn('   Antiga:', url.substring(0, 100));
      console.warn('   Nova:', correctedUrl.substring(0, 100));
      url = correctedUrl;
      
      // Recriar o input com a URL corrigida
      if (typeof input === 'string') {
        input = url;
      } else if (input instanceof URL) {
        input = new URL(url);
      } else if (input && 'url' in input) {
        input = new Request(url, input);
      }
    }
    
    return originalFetch.call(this, input, init);
  };
  
  // INTERCEPTAR XMLHttpRequest (Supabase pode usar isso tamb√©m)
  const OriginalXHR = window.XMLHttpRequest;
  window.XMLHttpRequest = function() {
    const xhr = new OriginalXHR();
    const originalOpen = xhr.open;
    
    xhr.open = function(method: string, url: string | URL, ...args: any[]) {
      const urlStr = typeof url === 'string' ? url : url.toString();
      if (urlStr && (urlStr.includes('qbtqjrcfseqcfmcqlngr') || urlStr.includes('gbtqjrcfseqcfmcqlngr') || urlStr.includes('jibpvpqgplmahjhswiza'))) {
        const correctedUrl = urlStr.replace(/https?:\/\/[^/]+\.supabase\.co/g, supabaseUrl);
        console.warn('‚ö†Ô∏è [CLIENT-XHR] URL antiga detectada, corrigindo:', urlStr.substring(0, 100), '‚Üí', correctedUrl.substring(0, 100));
        return originalOpen.call(this, method, correctedUrl, ...args);
      }
      return originalOpen.call(this, method, url, ...args);
    };
    
    return xhr;
  };
  
  console.log('‚úÖ [CLIENT] Interceptores de fetch e XMLHttpRequest instalados');
}
